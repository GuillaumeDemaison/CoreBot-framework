// Load tools library
let tools = require(__basedir + 'lib/tools');

// Load required lib
let _ = require("underscore");

// AutoReply loader
exports.run = function(bot, message, config){
    tools.debug('debug', 'module help run');

    let found = '';
    let to_say = '';
    let msg_arr = message.text.split(' ');

    // Reject if not Help command
    if (!/^help/i.test(message.text)) {
        tools.debug("info", 'module help run stop_no_command');
    }

    // Reject bot message
    else if (message.user === config.user) {
        tools.debug("info", 'module help run stop_bot_reply');
    }

    // Help of a module is requested (it includes detail)
    else if ((msg_arr.length > 1) && (!/^detail/i.test(msg_arr[1]))) {
        let res = _.each(config.module, function (conf, index) {
            if (index === msg_arr[1]) found = index;
        });
        if (found !== '')
            to_say = config.module[found].msg.help.join('\n');
        else
            to_say = to_say = config.module.help.msg.nomodule;
    }
    // If all help are requested
    else if ((msg_arr.length === 1) || (!/detail/i.test(message.text))) {
        _.each(config.module, function (conf, index) {
            console.log('config.module['+index+'].msg.help');

            // Help request on all modules but without detail
            if ((msg_arr.length === 1) && (config.module[index].enable === true))
                to_say += '- '+index+' - '+config.module[index].msg.help[0] + '\n';
            else if (msg_arr.length > 1){
                to_say += '# '+index+'\n';
                to_say += 'State: _'+ config.module[index].enable + '_\n\n';
                to_say += config.module[index].msg.help.join('\n\n');
            }
        });
    }

    if (to_say) bot.reply(message, to_say);
};

